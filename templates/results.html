{% extends "base.html" %}

{% block title %}GPT Pull-down{% endblock %}

{% block content %}
    <h1>GPT Pull-down</h1>
    <h5>> Let GPT guess what your protein binds to</h5>
    <hr style="border-top: 1px solid #ccc;">

    <p>Target Protein: {{ query }}</p>
    <table class="table">
    <thead>
      <tr>
        <th scope="col">Protein Name</th>
        <th scope="col">Confidence score (0-100)</th>
        <th scope="col">Function of the protein</th>
        <th scope="col">Function of the interaction</th>
        <th scope="col">Reasoning by GPT</th>
      </tr>
    </thead>
    <tbody>
      {% for protein in choices %}
        {% set protein_parts = protein.split(';') %}
        <tr>
          <td>{{ protein_parts[0].strip() if protein_parts|length > 0 else '' }}</td>
          <td>{{ protein_parts[1].strip() if protein_parts|length > 1 else '' }}</td>
          <td>{{ protein_parts[2].strip() if protein_parts|length > 2 else '' }}</td>
          <td>{{ protein_parts[3].strip() if protein_parts|length > 3 else '' }}</td>
          <td>{{ protein_parts[4].strip() if protein_parts|length > 4 else '' }}</td>
        </tr>
      {% endfor %}
    </tbody>
    </table>
    <a href="/" class="btn btn-primary">New Search</a>

    <!-- Add the button to fetch the purification protocol -->
    <button class="btn btn-secondary" id="getPurificationProtocolBtn">Get purification protocol</button>
    <hr>
    <div class="accordion" id="purificationProtocolAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
            Purification Protocol
          </button>
        </h2>
        <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#purificationProtocolAccordion">
          <div class="accordion-body" id="purificationProtocol"></div>
        </div>
      </div>
    </div>
    <hr style="border-top: 1px solid #ccc;">
{% endblock %}

{% block scripts %}
    <script>
      $("#getPurificationProtocolBtn").on("click", function() {
        const query = "{{ query }}";
        const temperature = {{ temperature }};
        $.ajax({
          url: "/get_purification_protocol",
          type: "POST",
          data: {
            query: query,
            temperature: temperature
          },
          success: function(response) {
            const protocol = JSON.parse(response);
            let protocolHTML = "";
            for (let line of protocol) {
              protocolHTML += `<p>${line}</p>`;
            }
            $("#purificationProtocol").html(protocolHTML);
            if ($("#collapseOne").hasClass("collapse")) {
              $("#collapseOne").collapse("show");
            }
          }
        });
      });
    </script>
{% endblock %}
